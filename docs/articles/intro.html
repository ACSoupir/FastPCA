<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using FastPCA on Large Matrices • FastPCA</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using FastPCA on Large Matrices">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FastPCA</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.3.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Using FastPCA on Large Matrices</a>
    </li>
    <li>
      <a href="../articles/SpatialTranscriptomics.html">FastPCA with Single Cell Spatial Transcriptomics</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ACSoupir/FastPCA/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using FastPCA on Large Matrices</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ACSoupir/FastPCA/blob/HEAD/vignettes/intro.Rmd" class="external-link"><code>vignettes/intro.Rmd</code></a></small>
      <div class="hidden name"><code>intro.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="fastpca">FastPCA!<a class="anchor" aria-label="anchor" href="#fastpca"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ACSoupir/FastPCA" class="external-link">FastPCA</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Thank you for using FastPCA!</span></span>
<span><span class="co">#&gt; To cite this package, run: citation('FastPCA')</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#dplyr</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="co">#ggplot</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">#magrittr</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://magrittr.tidyverse.org" class="external-link">"magrittr"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"magrittr"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="co">#bench</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://bench.r-lib.org/" class="external-link">"bench"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"bench"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bench.r-lib.org/" class="external-link">bench</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="example-data">Example Data<a class="anchor" aria-label="anchor" href="#example-data"></a>
</h3>
<p>Typically data exported for biological studies have rows as features
and samples as columns. Think about the bulk sequencing studies - have
each row as a gene and a few columns representing samples. As we move to
higher and higher resolution we are getting larger and larger sample
sizes, but the number of genes haven’t changed. Now we are stretching
hundreds of thousands of samples and still a few thousand features
profiled for those samples. To simulate this data, will generate 10,000
samples (columns) each with 200 features (rows) to start with.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_samples</span> <span class="op">=</span> <span class="fl">10000</span></span>
<span><span class="va">n_features</span> <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="va">n_groups</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="va">prop_diff</span><span class="op">=</span><span class="fl">0.4</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">333</span><span class="op">)</span></span>
<span><span class="co">#samples</span></span>
<span><span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">n_groups</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="va">n_samples</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">*</span><span class="va">n_features</span>, rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">*</span><span class="va">n_features</span>, mean <span class="op">=</span><span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> </span>
<span>  <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">*</span><span class="va">n_features</span>, rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">dat</span>, nrow<span class="op">=</span><span class="va">n_features</span>, ncol<span class="op">=</span><span class="va">n_samples</span>,</span>
<span>            dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"feature_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_features</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cell_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diff_feat1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_features</span>, <span class="fl">1</span>, <span class="va">prop_diff</span><span class="op">)</span></span>
<span><span class="va">diff_feat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_features</span>, <span class="fl">1</span>, <span class="va">prop_diff</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">n_features</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">diff_feat1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">diff_feat2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">zero_inflated_locs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">0.3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">[</span><span class="va">zero_inflated_locs</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="prepping-data">Prepping Data<a class="anchor" aria-label="anchor" href="#prepping-data"></a>
</h2>
<p>Within <code>FastPCA</code>, we’ve included a function to help prep
data for use with the main function. Base R can sometimes be faster but
in the event a really large data set is being used and GPU is available,
its possible the <code><a href="../reference/prep_matrix.html">prep_matrix()</a></code> function is faster. In
either case, <code><a href="../reference/prep_matrix.html">prep_matrix()</a></code> can do 3 things:</p>
<ol style="list-style-type: decimal">
<li>log2 transform the data</li>
<li>transpose the matrix from columns being samples to rows being
samples (needed for the main function)</li>
<li>scale the data to mean center and unit variance</li>
</ol>
<p>In this vignette (if viewing the raw markdown), I’ve included code to
simulate some large data (200 features and 10,000 samples) to
demonstrate FastPCA speed vs the common IRLBA method. To quickly see
some of information about the simulated data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Data Summary:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Data Summary:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;       0       0    1884    3222    3846  244969</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Data Dimensions:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Data Dimensions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   200 10000</span></span></code></pre></div>
<p>Because our main work is with spatial omics which tends to be zero
inflated, this simulated data is also zero inflated (attempting to
roughly mimic that of MALDI imaging data). To prevent issues with log2
transformations of 0 (-infinity), we are adding <code>1</code> to the
matrix <code>X</code> bringing those values back to 0 after
transformation. We will also transpose the data to have samples as rows
and scale it so all features can be used. To speed up some of the
process, we can increase cores, though, there is diminishing returns
because the operations are</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_mat</span> <span class="op">=</span> <span class="fu"><a href="../reference/prep_matrix.html">prep_matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                          log2 <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          transpose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The matrix is now log2 transformed, scaled, and tranposed to have
samples as rows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Data Summary:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Data Summary:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">prepped_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt; -1.5512 -1.4894  0.5219  0.0000  0.7077  1.5530</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Data Dimensions:"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Data Dimensions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">prepped_mat</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10000   200</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-fastpca">Running FastPCA<a class="anchor" aria-label="anchor" href="#running-fastpca"></a>
</h2>
<p><code><a href="../reference/FastPCA.html">FastPCA()</a></code> works by randomized singular value
decomposition (SVD) to calculate a subset of the top dimensions in the
data. To do this, it needs to know how many dimensions to return
(<code>k</code>), some number of over sampling dimensions (meaning that
if a user wants 10 dimension, how many extra to calculate on in order to
make the 10 desired more accurate; <code>p</code>), as well as ‘power
iterations’ which is the number of times the data is multiplied by
itself and re-orthogonalized to maintain accuracy in the higher
dimensions (<code>q_iter</code>). If wanted, <code><a href="../reference/FastPCA.html">FastPCA()</a></code> can
return the exact SVD information, and typically does so faster than
other implemented tools in R like IRLBA, but for things like single cell
data analysis most of the information between cell types is held in the
top 50-200 or so PCs, which allows these more memory efficient methods
to extract meaningful information out of the data. Further, because
<code><a href="../reference/FastPCA.html">FastPCA()</a></code> uses matrix operation tools built for deep
learning, it’s possible to use GPUs as the compute engine to offer
further speed-ups. Not really needed, but nice to have.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fastpca_res</span> <span class="op">=</span> <span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                      k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                      p <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                      q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                      cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                      backend <span class="op">=</span> <span class="st">"r"</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/FastPCA.html">FastPCA()</a></code> has the left (<code>U</code>)
and right (<code>Vh</code>) singular vectors, as well as the singular
values (<code>S</code>). This is similar to functions like
<code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> but different than <code><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp()</a></code>
which returns the rotation (eigenvectors) as well as scores by default.
Because <code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> is similar to <code><a href="../reference/FastPCA.html">FastPCA()</a></code>
in returning the reduced SVD list, lets do some benchmarking using
<code>bench</code> package.</p>
</div>
<div class="section level2">
<h2 id="benchmarking">Benchmarking<a class="anchor" aria-label="anchor" href="#benchmarking"></a>
</h2>
<p>We will use the same <code>prepped_mat</code> above that has 10,000
samples and 200 features, similar shape that we would see with
biological data where we are profiling genes in a tissue, or we are
imaging a tissue for lipids and each pixel has a spectral profile.
<strong>Run on your local machine or see other vignette on the GitHub
for speed demonstrations.</strong></p>
<div class="section level3">
<h3 id="irlba">
<code>IRLBA</code><a class="anchor" aria-label="anchor" href="#irlba"></a>
</h3>
<p>First, <code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code>. <code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> is a
fantastic function the iterates until tolerance is reached in the
singular vectors and singular values making very accurate. In
combination with accuracy, because it uses the reduced space, it
consumes much less memory on these large matrices than
<code><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">stats::prcomp()</a></code>, which will attempt to calculate the full
vectors. However, it is single-threaded, meaning that the larger the
reduced space is and the input data, the longer it will take to
converge. This isn’t an issue for pipelines with typical single cell
data analyses that have a pretty well defined workflow from the raw data
to something that can be interrogated for biological meaning. Where the
starts to hinder work is in things such as our spatial transcriptomic
studies that we want to test different data normalization methods,
transformation, adjustments, etc. Each time the data is normalized a
different way (such as using nuclear size, spatially informed
normalization, or just typical log2 following library size), the whole
dimension reduction needs to be performed again. Further, to attempt to
increase speed and decrease memory requirements, some implementations
have reduced the input data to include only those features that are most
variable globally which inherenly removes information from the data.</p>
<p>Anyhow, all this to say <code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> is fantastic,
accurate, and has a low memory foot print, with a few flaws. To
demonstrate <code><a href="../reference/FastPCA.html">FastPCA()</a></code> to <code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code>, we
will extract 5, 10, and 20 most variable dimensions from the data
tracking time and memory, and will visualize the output between them
afterwards. The only other parameter I’m setting is for making sure that
the minimum amount of time the speed and is being assessed over to 5
seconds.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irlba_time_k5_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>irlba <span class="op">=</span> <span class="fu">irlba</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba</a></span><span class="op">(</span><span class="va">prepped_mat</span>, nv <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">irlba_time_k10_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>irlba <span class="op">=</span> <span class="fu">irlba</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba</a></span><span class="op">(</span><span class="va">prepped_mat</span>, nv <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">irlba_time_k20_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>irlba <span class="op">=</span> <span class="fu">irlba</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba</a></span><span class="op">(</span><span class="va">prepped_mat</span>, nv <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fastpca-1">
<code>FastPCA</code><a class="anchor" aria-label="anchor" href="#fastpca-1"></a>
</h3>
<p>As previously discussed, <code><a href="../reference/FastPCA.html">FastPCA()</a></code> also allows for using
multiple threads but this must be started at the beginning of a session
with the pytorch backend. Unfortunately, because of CRAN checks, this
vignette is stuck using base R/irlba rather than demonstrating the
faster methods. This is because the <code>'rtorch'</code> backend
requires the additional installation of <code>libtorch</code>, and
<code>pytorch</code> requires an environment which to my knowledge CRAN
would fail builds over. Below is simply demonstration code for how one
could perform the benchmarks themselves.</p>
<p>In addition to profiling extracting 5, 10, and 20 dimensions we can
also assess using 1 core and 4 cores. This data set is likely too small
to see any real difference from the number of threads unless the number
or dimensions is increased and the number of power iterations increased
(which has diminishing returns). For the sake of testing, will calculate
50 dimensions with 10 oversampling dimensions perform 5 power
iterations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/start_FastPCA_env.html">start_FastPCA_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k5_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k10_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k20_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k50_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k5_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k10_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k20_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">fast_pca_time_k50_c1</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>fastpca_res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/FastPCA.html">FastPCA</a></span><span class="op">(</span><span class="va">prepped_mat</span>,</span>
<span>                                  k <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                  p <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  q_iter <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  backend <span class="op">=</span> <span class="st">"pytorch"</span><span class="op">)</span><span class="op">)</span>, min_time <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="putting-it-together">Putting it Together<a class="anchor" aria-label="anchor" href="#putting-it-together"></a>
</h3>
<p><strong>The chunks below can be ran on your own machine to plot the
results</strong></p>
<p>Merging all the results (which could be done in a single call to
<code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark()</a></code> with <code>check=FALSE</code>), we can then
plot the results. The output of <code><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">bench::mark()</a></code> has time and
memory, so will plot time on the x axis and memory usage on the y
axis.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"time_k"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pl_dat</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">time_res</span>, .id <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>smaller <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*time_"</span>, <span class="st">""</span>, <span class="va">source</span><span class="op">)</span>,</span>
<span>                  cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*\\_"</span>, <span class="st">""</span>, <span class="va">smaller</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                  dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\_.*"</span>, <span class="st">""</span>, <span class="va">smaller</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                  function_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pl_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span>, </span>
<span>                   y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mem_alloc</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span>, </span>
<span>                   shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cores</span><span class="op">)</span>, </span>
<span>                   size <span class="op">=</span> <span class="va">function_name</span>, </span>
<span>                   color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span>, </span>
<span>                   stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"CPU Cores"</span><span class="op">)</span>,</span>
<span>         shape <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Dimensions"</span><span class="op">)</span>,</span>
<span>         color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"SVD Method"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time (ms)"</span>, y <span class="op">=</span> <span class="st">"Memory (Mb)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">lims</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the increase in time and memory for
<code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> as we discussed - as the number of
dimensions extracted increases, memory and time also increases almost
linearly. Conversely, we can see that the besides the run with
<code><a href="../reference/FastPCA.html">FastPCA()</a></code> that intentionally increased compute the time was
pretty consistent for this data while memory increased with the number
of reduced dimensions extracted. It’s difficult to really see the
differences between the runs with 1 core and 4 cores for these 3
dimension sizes. When we extract more dimensions and perform the
increased number of power iterations, it uses more memory and takes
longer, but we still don’t have quite enough to see a benefit from th
enumber of CPU cores. When data is hundreds of thousands of samples and
thousands of features, then the increased core count helps.</p>
<p>We can also compare the extracted eigenvalues, using
<code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> as the gold standard.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pl_dat</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">=</span> <span class="va">pl_dat</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="st">"S"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">S</span> <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">S</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">S</span> <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>func <span class="op">=</span> <span class="va">pl_dat</span><span class="op">$</span><span class="va">source</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>                    ord <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>,</span>
<span>                    cores <span class="op">=</span> <span class="va">pl_dat</span><span class="op">$</span><span class="va">cores</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>                    SV <span class="op">=</span> <span class="va">S</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cores</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>func <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_c.*"</span>, <span class="st">""</span>, <span class="va">func</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_time"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">combos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>left <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">svs</span><span class="op">$</span><span class="va">func</span><span class="op">)</span>,</span>
<span>                     right <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">svs</span><span class="op">$</span><span class="va">func</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">left</span> <span class="op">!=</span> <span class="va">right</span><span class="op">)</span></span>
<span><span class="va">merged_svs</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">combos</span>, <span class="va">svs</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span> <span class="op">=</span> <span class="st">"func"</span><span class="op">)</span>,relationship <span class="op">=</span> <span class="st">"many-to-many"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">svs</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"right"</span> <span class="op">=</span> <span class="st">"func"</span>, <span class="st">"ord"</span> <span class="op">=</span> <span class="st">"ord"</span><span class="op">)</span>,relationship <span class="op">=</span> <span class="st">"many-to-many"</span><span class="op">)</span></span>
<span><span class="va">merged_svs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">SV.x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">SV.y</span><span class="op">)</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">ord</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">left</span> <span class="op">~</span> <span class="va">right</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Value\nRank"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Singular Value (log2)"</span>, y <span class="op">=</span> <span class="st">"Singular Value (log2)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This data isn’t real so there isn’t much for structured differences
in groups within the data. Because of this only a few PCs would be
needed to identify groups in the data. Here we can see that 2 PC explain
a large portion of the variance (which we calculate below) and then from
PC3 on is all pretty minimal (~0.6% each). With more structure, the
singular values and vectors are more stable but from random data, is
difficult to extract meaningful information. Even so, if we look at the
the higher singular values (3, 4, and 5), they are all pretty stable
with slight deviations. In real biological data, we’ve seen that
<code><a href="../reference/FastPCA.html">FastPCA()</a></code> only starts to deviate slightly from
<code><a href="https://rdrr.io/pkg/irlba/man/irlba.html" class="external-link">irlba::irlba()</a></code> at ~50 PCs and even then it’s fractions of a
percent different varaince explained.</p>
<p>For the total variance that each PC explains, we can sum the squared
input matrix (assuming that it’s centered and unit variance scaled) to
identify the full variance of the data. Then, if we square each singular
value and divide by the total variance, we see the proportion explained.
Here I’ve then multiplied by 100 to get it as a percent.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_var</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prepped_mat</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">var_explained</span> <span class="op">=</span> <span class="op">(</span><span class="va">time_res</span><span class="op">$</span><span class="va">fast_pca_time_k50_c1</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">S</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">total_var</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="st">": "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">var_explained</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="st">"%"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="setting-up-fastpca-with-reticulate">Setting up FastPCA with Reticulate<a class="anchor" aria-label="anchor" href="#setting-up-fastpca-with-reticulate"></a>
</h2>
<p>In order to use <code>FastPCA</code> with certain functionalities
(like <code>pytorch</code> backend for <code><a href="../reference/prep_matrix.html">prep_matrix()</a></code> and
<code><a href="../reference/FastPCA.html">FastPCA()</a></code>, and <code>umap-learn</code> for
<code><a href="../reference/umap.html">umap()</a></code>), an environment needs to best created using
<code><a href="../reference/setup_py_env.html">setup_py_env()</a></code>. It’s recommended to use
<code>method = 'conda'</code> for the environment as there are some
perks, especially if there is a CUDA device available. To create the
environment, simply call the function. Here, we already have one on the
system so the function call tells us.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/setup_py_env.html">setup_py_env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Then, after we have the environment built, we can activate it with
another <code>FastPCA</code> functioned:
<code><a href="../reference/start_FastPCA_env.html">start_FastPCA_env()</a></code>. Since <code><a href="../reference/setup_py_env.html">setup_py_env()</a></code> was
run with default parameters, running <code><a href="../reference/start_FastPCA_env.html">start_FastPCA_env()</a></code>
with default parameters will automatically select the right environment
type (<code>conda</code> over <code>virtualenv</code>) and the
environment name (<code>FastPCA</code>) to start. <strong>Note: if you
have run other functions such as using <code>rtorch</code> backend or
select functions from <code>Seurat</code>, the environment may get
activated but still fail to have the modules active. This seems to be an
issue underlying the reticulate package, NOT
<code>FastPCA</code></strong>. Its recommended to restart your session
and <em>then</em> activate the environment to use the python backend.
Alternatively, just use <code>rtorch</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/start_FastPCA_env.html">start_FastPCA_env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>To make sure that the right environment is loaded for use,
<code><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">reticulate::py_config()</a></code> can be ran, which we should see
having <code>FastPCA</code> in the path, or the environment name set
when setting up the environment. If <code>reticulate</code> is in the
path, unless explicitly named that, it is likely that
<code>reticulate</code> itself loaded an environment. If that happens,
restart your R session and then start with
<code><a href="../reference/start_FastPCA_env.html">start_FastPCA_env()</a></code> followed by
<code><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">reticulate::py_config()</a></code> to make sure that the right
environment is loaded.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_config.html" class="external-link">py_config</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alex Soupir.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
